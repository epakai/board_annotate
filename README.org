This is a tool for annotating circuit boards in Inkscape.

It takes:
    - a circuit board photo
    - chip photos
    - a yaml config with chip information and configuration options
    - an appropriate Inkscape document
Then you play a quick matching game, and it produces little colored annotations around the board image. See [[#screenshot]].

Only tested with Inkscape 1.2.2. Requires Inkscape 1.2 or higher.

All images are embedded in the SVG (for now).

* Install 

For now, put the 'board_annotate' py, ui, and inx files into =~/.config/inkscape/extensions=.

It should appear in Inkscape's =Extensions -> Render= menu as 'Board Annotate'.

* Steps

** Preparation
- throw the board and chips images into a folder
- edit photos (adjust alignment, crop, rotate, adjust contrast)
    + about 10 minutes for 16 chips using gphoto
- create a yaml config like:

#+BEGIN_SRC yaml
gutter: horizontal
board_photo: board.jpg
chips:
  - name: Chip 1
    chip_photo: chip1.jpg
    description: About Chip 1
  - name: Chip 2
    chip_photo: chip2.jpg
    description: About Chip 2
#+END_SRC

For empty fields, use "". =chip_photo= and =description= can be empty

=chip_photo= can be an absolute path, otherwise it is relative to the yaml file.

=gutter= sets where the annotations are drawn. It can be =horizontal= (drawn above and below, or =vertical= (drawn on the left and right).

** In Inkscape
- create a new image
- put the board photo in it
- probably resize it to use one full dimension of the page
- leave gutter space above​/below or on the left​/right
    + gutters don't have to be even
- draw a rectangle on top of every chip
- select the rectangles
- run the extension (=Extensions > Render > Board Annotate=)

** The extension
- select your yaml file with the file picker, hit apply
- match chips to images (click on 'Select a chip' twice to open the selection)
- hit apply once all chips have been matched
- close the error window
- images will be embedded, and annotations drawn

See [[file:usage.org][usage]]

* Other config options
** image_ratio
Annotations have a ratio between image and text. The default is 0.6 (image). It can be set like:

#+BEGIN_SRC yaml
image_ratio: 0.4
#+END_SRC

Bigger image ratios:
    - increase the gutter fill (less empty space)
    - make the text area wider and shorter
    - probably don't make sense for vertical gutters

Smaller image ratios:
    - reduce fill (useful if the gutters are over full)
    - make the text area narrower, and taller

** palette and colors

Palettes set the colors of the annotation surround, connectors, chip location recangle, and layer highlight color. 

There are a few built-in color palettes. They are specified with 'palette' key, and can be:
- =default= :: SVG named colors excluding light/dark/medium, and colors I found undesirable (whites, blacks, greys, brows, beiges).
- =dark= :: SVG named colors starting with 'dark'
- =light= :: SVG named colors starting with 'light' or 'pale'
- =medium= :: SVG named colors starting with 'medium'
- =all= :: all of the above combined in that order
- =all_random= :: all, but sorted randomly

Palette can also be set to =custom= or =custom_random=. Custom requires a second key, =colors=, for the list of colors. These can be color names, HTML color codes (must be quoted), integers, or hex values.

There is no minimum, the color list will repeat when exhausted.

Here's an example:

#+BEGIN_SRC yaml
palette: custom
colors:
  - '#263C8B'
  - 0x4e74A6FF
  - beige
  - goldenrod
  - "#2E231F"
#+END_SRC

* Screenshot

[[screenshot.png]]

* TODO Things to be done, probably
** GUI stuff
- can the combo box display everything? not without a custom cell renderer, or moving away from TreeView
- This UI ended up being pretty bad, but it does the job
    + Currently you scroll a lot, and have to click twice to open the selection drop down.
    + After using it, I think:
        * The UI should be a small match list area, and a large matching area.
        * The match list area indicates match status, and lets the user easily access any match
        * The match area displays one photo and selection list.
        * The user selects, then has keyboard+gui controls to move forward, and backward.

** Testing and edge cases
- test with bad file paths
- test with empty name, description, photo etc.
- what happens if the gutter fills up?
- what happens if both gutters fills up?
- what happens with rects in the gutter?
    + overlapping the gutter?
    + outside the page?
    + straddling the page border?
- Lots of missing input verification when accessing the yaml config

** Bugs
- Undo doesn't restore the selection. I think it was working previously.
- Connectors can pass through empty parts of the gutter
    + I could fill empty gutter space with rects that set 'connector-avoid', but that doesn't help with the current left to right gutter fill, and it makes extra work if the user wants to modify the arrangement.

** Enhancments
- Gutter filling is overly simple
    + Currently we fill left to right, and try to keep gutters evenly filled
    + My better idea:
        * Pick a dividing line that makes for roughly equal gutter fill
        * Position every annotation directly above its first matching chip
        * Work from the center and bump overlapping annotations outward
        * Drawing becomes a separate step
- Could probably determine gutter orientation automatically
- More user appearance settings:
    + fonts, sizes, text color, backgrounds
    + box/path stroke width
- Allow non-rect shapes (for annotating areas and functional blocks)
- Connectors could be optional (just outline the chip and annotation)
- Write back matches to the yaml file? 
    + would make it much easier to iterate if the matchset hasn't changed
    + would need a checkbox to save matches
    + an option somewhere to erase matches
    + extra checks to ensure matching rectangles still exist
- Some way to indicate the annotated chip is on the reverse side of the board (for when it's not worth annotating both sides)
- Resize embedded images to match DPI. 
    + Could be worth automating to reduce output SVG size.
    + Edit > Make a Bitmap Copy
    + This makes a copy with the DPI based on an Inkscape preference
    + Then grab the original and delete it
- A layout more suited for text only (no zoomed chip photos)
- Avoid colors close to the circuit board color
    + probably average the gdkpixbuf colors, and skip colors close to it
- should probably inset the image inside the border
- maybe allow groups in the selection but filter them for processing
    + does selecting a group automatically include its children?
- non-embedded photos

* Other considerations
- genericize the names, this can probably be used for non-circuit board things
    + Board annotate ->
    + board_photo -> 
    + chip_photo -> 
    + chip
    + board
